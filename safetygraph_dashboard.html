<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ SafetyGraph Dashboard - 16 Secteurs SCIAN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        
        .glow-text {
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #0a0a1a;
        }
        
        .sector-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(0, 212, 255, 0.3); border-radius: 4px; }
    </style>
</head>
<body class="text-white">

<!-- Header -->
<header class="glass-card mx-4 mt-4 p-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold glow-text">ğŸ›¡ï¸ SafetyGraph Dashboard</h1>
            <p class="text-cyan-400 mt-1">EDGY-AgenticX5 | 16 Secteurs SCIAN | Neo4j Knowledge Graph</p>
        </div>
        <div class="text-right">
            <p class="text-gray-400 text-sm">DerniÃ¨re mise Ã  jour</p>
            <p class="text-cyan-400 font-semibold" id="lastUpdate">28 novembre 2025</p>
        </div>
    </div>
</header>

<!-- KPIs -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mx-4 mt-6">
    <div class="glass-card kpi-card p-4 text-center">
        <div class="text-3xl mb-2">ğŸ¢</div>
        <div class="text-3xl font-bold text-cyan-400" id="kpi-orgs">460</div>
        <div class="text-gray-400 text-sm">Organisations</div>
    </div>
    <div class="glass-card kpi-card p-4 text-center">
        <div class="text-3xl mb-2">ğŸ‘¥</div>
        <div class="text-3xl font-bold text-cyan-400" id="kpi-persons">3,926</div>
        <div class="text-gray-400 text-sm">Personnes</div>
    </div>
    <div class="glass-card kpi-card p-4 text-center">
        <div class="text-3xl mb-2">âš ï¸</div>
        <div class="text-3xl font-bold text-orange-400" id="kpi-risks">2,870</div>
        <div class="text-gray-400 text-sm">Risques</div>
    </div>
    <div class="glass-card kpi-card p-4 text-center">
        <div class="text-3xl mb-2">ğŸ“</div>
        <div class="text-3xl font-bold text-green-400" id="kpi-zones">1,429</div>
        <div class="text-gray-400 text-sm">Zones</div>
    </div>
    <div class="glass-card kpi-card p-4 text-center">
        <div class="text-3xl mb-2">ğŸ‘”</div>
        <div class="text-3xl font-bold text-purple-400" id="kpi-teams">1,125</div>
        <div class="text-gray-400 text-sm">Ã‰quipes</div>
    </div>
    <div class="glass-card kpi-card p-4 text-center">
        <div class="text-3xl mb-2">ğŸ¯</div>
        <div class="text-3xl font-bold text-pink-400" id="kpi-roles">2,363</div>
        <div class="text-gray-400 text-sm">RÃ´les</div>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="flex gap-2 mx-4 mt-6 overflow-x-auto pb-2">
    <button onclick="showTab('overview')" id="tab-overview" class="tab-active px-6 py-3 rounded-full font-semibold whitespace-nowrap transition-all">
        ğŸ  Vue d'ensemble
    </button>
    <button onclick="showTab('sectors')" id="tab-sectors" class="glass-card px-6 py-3 rounded-full font-semibold whitespace-nowrap hover:bg-white/10 transition-all">
        ğŸ­ Secteurs SCIAN
    </button>
    <button onclick="showTab('risks')" id="tab-risks" class="glass-card px-6 py-3 rounded-full font-semibold whitespace-nowrap hover:bg-white/10 transition-all">
        âš ï¸ Risques
    </button>
    <button onclick="showTab('orgs')" id="tab-orgs" class="glass-card px-6 py-3 rounded-full font-semibold whitespace-nowrap hover:bg-white/10 transition-all">
        ğŸ¢ Organisations
    </button>
    <button onclick="showTab('analytics')" id="tab-analytics" class="glass-card px-6 py-3 rounded-full font-semibold whitespace-nowrap hover:bg-white/10 transition-all">
        ğŸ“ˆ Analyses
    </button>
</div>

<!-- Content Sections -->
<main class="mx-4 mt-6 mb-8">

    <!-- Overview Tab -->
    <div id="content-overview" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Organisations par secteur -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold mb-4">ğŸ“Š Organisations par secteur SCIAN</h3>
                <div id="chart-sectors" style="height: 500px;"></div>
            </div>
            
            <!-- Zones par niveau de risque -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold mb-4">ğŸ¯ Zones par niveau de risque</h3>
                <div id="chart-zones" style="height: 500px;"></div>
            </div>
        </div>
        
        <!-- Risques par catÃ©gorie -->
        <div class="glass-card p-6 mt-6">
            <h3 class="text-xl font-bold mb-4">âš ï¸ Risques par catÃ©gorie</h3>
            <div id="chart-risk-categories" style="height: 400px;"></div>
        </div>
    </div>

    <!-- Sectors Tab -->
    <div id="content-sectors" class="tab-content hidden">
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold mb-6">ğŸ­ 16 Secteurs SCIAN couverts</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="sectors-grid">
                <!-- GÃ©nÃ©rÃ© dynamiquement -->
            </div>
        </div>
        
        <div class="glass-card p-6 mt-6">
            <h3 class="text-xl font-bold mb-4">ğŸ“Š RÃ©partition des employÃ©s par secteur</h3>
            <div id="chart-employees" style="height: 500px;"></div>
        </div>
    </div>

    <!-- Risks Tab -->
    <div id="content-risks" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold mb-4">ğŸ”´ Matrice ProbabilitÃ© Ã— GravitÃ©</h3>
                <div id="chart-risk-matrix" style="height: 500px;"></div>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold mb-4">ğŸ“Š Distribution des scores de risque</h3>
                <div id="chart-risk-dist" style="height: 500px;"></div>
            </div>
        </div>
        
        <div class="glass-card p-6 mt-6">
            <h3 class="text-xl font-bold mb-4">ğŸ”´ Top 20 Risques TolÃ©rance ZÃ©ro</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="risks-table">
                    <thead class="border-b border-white/10">
                        <tr>
                            <th class="py-3 px-4">Description</th>
                            <th class="py-3 px-4">CatÃ©gorie</th>
                            <th class="py-3 px-4 text-center">P</th>
                            <th class="py-3 px-4 text-center">G</th>
                            <th class="py-3 px-4 text-center">Score</th>
                        </tr>
                    </thead>
                    <tbody id="risks-tbody">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Organizations Tab -->
    <div id="content-orgs" class="tab-content hidden">
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold mb-4">ğŸ† Top 25 organisations (par employÃ©s)</h3>
            <div id="chart-top-orgs" style="height: 700px;"></div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="content-analytics" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold mb-4">ğŸ‘¥ Distribution par groupe d'Ã¢ge</h3>
                <div id="chart-age" style="height: 400px;"></div>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold mb-4">ğŸ“ Certifications SST frÃ©quentes</h3>
                <div id="chart-certs" style="height: 400px;"></div>
            </div>
        </div>
        
        <div class="glass-card p-6 mt-6">
            <h3 class="text-xl font-bold mb-4">ğŸ”— RÃ©seau Organisations-Zones-Ã‰quipes</h3>
            <div id="chart-network" style="height: 500px;"></div>
        </div>
    </div>

</main>

<!-- Footer -->
<footer class="glass-card mx-4 mb-4 p-4 text-center text-gray-400">
    <p>ğŸ›¡ï¸ SafetyGraph | EDGY-AgenticX5 | Preventera | GenAISafety</p>
    <p class="text-sm mt-1">DonnÃ©es anonymisÃ©es conformÃ©ment Ã  la Loi 25 du QuÃ©bec</p>
</footer>

<script>
// ============================================================================
// DONNÃ‰ES SAFETYGRAPH (Ã‰tat actuel Neo4j)
// ============================================================================

const STATS = {
    orgs: 460,
    persons: 3926,
    risks: 2870,
    zones: 1429,
    teams: 1125,
    roles: 2363
};

const SECTEURS = [
    { scian: "54", nom: "ğŸ’¼ Services professionnels", orgs: 45, employes: 38000, couleur: "#6A5ACD" },
    { scian: "31-33", nom: "ğŸ­ Fabrication", orgs: 46, employes: 85000, couleur: "#4169E1" },
    { scian: "911-912", nom: "ğŸš’ Admin publiques", orgs: 32, employes: 42000, couleur: "#4682B4" },
    { scian: "236-238", nom: "ğŸ—ï¸ Construction", orgs: 32, employes: 28000, couleur: "#FF6347" },
    { scian: "621-624", nom: "ğŸ¥ SantÃ©", orgs: 31, employes: 95000, couleur: "#DC143C" },
    { scian: "311-312", nom: "ğŸ– Agroalimentaire", orgs: 31, employes: 35000, couleur: "#DAA520" },
    { scian: "561-562", nom: "ğŸ§¹ Services soutien", orgs: 30, employes: 22000, couleur: "#9370DB" },
    { scian: "72", nom: "ğŸ½ï¸ HÃ©bergement/Resto", orgs: 29, employes: 45000, couleur: "#FF69B4" },
    { scian: "44-45", nom: "ğŸ›’ Commerce dÃ©tail", orgs: 28, employes: 72000, couleur: "#32CD32" },
    { scian: "22", nom: "âš¡ Services publics", orgs: 26, employes: 28000, couleur: "#00CED1" },
    { scian: "484-493", nom: "ğŸš› Transport", orgs: 24, employes: 18000, couleur: "#FF8C00" },
    { scian: "237", nom: "âš¡ GÃ©nie civil", orgs: 21, employes: 12000, couleur: "#FFD700" },
    { scian: "212-213", nom: "â›ï¸ Mines", orgs: 17, employes: 15000, couleur: "#8B4513" },
    { scian: "111-115", nom: "ğŸŒ¾ Agriculture", orgs: 12, employes: 8000, couleur: "#228B22" },
    { scian: "611", nom: "ğŸ« Ã‰coles", orgs: 2, employes: 5000, couleur: "#FFB6C1" },
];

const ZONES_RISQUE = [
    { niveau: "critique", count: 180, couleur: "#DC143C" },
    { niveau: "eleve", count: 420, couleur: "#FF8C00" },
    { niveau: "moyen", count: 650, couleur: "#FFD700" },
    { niveau: "faible", count: 179, couleur: "#32CD32" }
];

const CATEGORIES_RISQUE = [
    { cat: "ergonomique", count: 680, score: 12 },
    { cat: "mecanique", count: 520, score: 14 },
    { cat: "chimique", count: 380, score: 15 },
    { cat: "chute", count: 340, score: 16 },
    { cat: "psychosocial", count: 320, score: 11 },
    { cat: "electrique", count: 180, score: 18 },
    { cat: "thermique", count: 150, score: 10 },
    { cat: "violence", count: 120, score: 14 },
    { cat: "routier", count: 100, score: 16 },
    { cat: "bruit", count: 80, score: 8 }
];

const TOP_ORGS = [
    { nom: "Walmart Canada (QuÃ©bec)", secteur: "44-45", employes: 8500 },
    { nom: "Metro Inc.", secteur: "44-45", employes: 8500 },
    { nom: "IGA (Sobeys)", secteur: "44-45", employes: 6500 },
    { nom: "CGI QuÃ©bec", secteur: "54", employes: 5500 },
    { nom: "Couche-Tard", secteur: "44-45", employes: 5500 },
    { nom: "WSP QuÃ©bec", secteur: "54", employes: 4500 },
    { nom: "Tim Hortons QuÃ©bec", secteur: "72", employes: 4500 },
    { nom: "Costco QuÃ©bec", secteur: "44-45", employes: 4500 },
    { nom: "Hydro-QuÃ©bec Production", secteur: "22", employes: 4500 },
    { nom: "RONA (Lowe's Canada)", secteur: "44-45", employes: 4500 },
    { nom: "Ubisoft MontrÃ©al", secteur: "54", employes: 4000 },
    { nom: "Maxi (Loblaw)", secteur: "44-45", employes: 4500 },
    { nom: "McDonald's QuÃ©bec", secteur: "72", employes: 3800 },
    { nom: "Dollarama", secteur: "44-45", employes: 3500 },
    { nom: "SNC-Lavalin", secteur: "54", employes: 3500 },
    { nom: "Provigo (Loblaw)", secteur: "44-45", employes: 3200 },
    { nom: "Home Depot QuÃ©bec", secteur: "44-45", employes: 3200 },
    { nom: "Super C (Metro)", secteur: "44-45", employes: 2800 },
    { nom: "Compass Group", secteur: "72", employes: 2500 },
    { nom: "Desjardins TI", secteur: "54", employes: 2500 },
    { nom: "Winners/HomeSense", secteur: "44-45", employes: 2200 },
    { nom: "Groupe MTY", secteur: "72", employes: 2200 },
    { nom: "Deloitte QuÃ©bec", secteur: "54", employes: 1800 },
    { nom: "Stantec QuÃ©bec", secteur: "54", employes: 1800 },
    { nom: "Sodexo QuÃ©bec", secteur: "72", employes: 1800 }
];

const RISQUES_TZ = [
    { desc: "Ã‰lectrocution haute tension (735kV)", cat: "electrique", p: 3, g: 5, score: 15 },
    { desc: "Arc Ã©lectrique flash", cat: "electrique", p: 3, g: 5, score: 15 },
    { desc: "Ã‰crasement chariot Ã©lÃ©vateur", cat: "mecanique", p: 3, g: 5, score: 15 },
    { desc: "Explosion gaz naturel", cat: "chimique", p: 3, g: 5, score: 15 },
    { desc: "Chute hauteur (>3m)", cat: "chute", p: 3, g: 5, score: 15 },
    { desc: "Effondrement excavation", cat: "mecanique", p: 3, g: 5, score: 15 },
    { desc: "Asphyxie espace clos (H2S)", cat: "chimique", p: 3, g: 5, score: 15 },
    { desc: "Collision Ã©quipement lourd", cat: "mecanique", p: 3, g: 5, score: 15 },
    { desc: "Incendie/explosion solvants", cat: "chimique", p: 3, g: 5, score: 15 },
    { desc: "Noyade (rÃ©servoir, barrage)", cat: "physique", p: 3, g: 5, score: 15 },
    { desc: "Exposition amiante", cat: "chimique", p: 2, g: 5, score: 10 },
    { desc: "Renversement vÃ©hicule minier", cat: "mecanique", p: 3, g: 5, score: 15 },
    { desc: "Ã‰boulement souterrain", cat: "mecanique", p: 2, g: 5, score: 10 },
    { desc: "Chute palette/rayonnage", cat: "mecanique", p: 4, g: 5, score: 20 },
    { desc: "Vol Ã  main armÃ©e", cat: "violence", p: 3, g: 5, score: 15 },
    { desc: "BrÃ»lure four industriel", cat: "thermique", p: 3, g: 5, score: 15 },
    { desc: "Coincement machine rotative", cat: "mecanique", p: 3, g: 5, score: 15 },
    { desc: "Intoxication monoxyde carbone", cat: "chimique", p: 2, g: 5, score: 10 },
    { desc: "Radiation (laboratoire)", cat: "physique", p: 2, g: 5, score: 10 },
    { desc: "Ã‰crasement presse hydraulique", cat: "mecanique", p: 2, g: 5, score: 10 }
];

const AGE_DISTRIBUTION = [
    { age: "18-24", count: 580 },
    { age: "25-34", count: 1250 },
    { age: "35-44", count: 1100 },
    { age: "45-54", count: 720 },
    { age: "55-64", count: 276 }
];

const CERTIFICATIONS = [
    { cert: "SIMDUT", count: 2800 },
    { cert: "Premiers soins", count: 2650 },
    { cert: "Manutention sÃ©curitaire", count: 1850 },
    { cert: "ASP Construction", count: 1200 },
    { cert: "Cadenassage (LOTO)", count: 980 },
    { cert: "Travail en hauteur", count: 850 },
    { cert: "Espace clos", count: 720 },
    { cert: "Cariste/Chariot Ã©lÃ©vateur", count: 680 },
    { cert: "RCR/DEA", count: 620 },
    { cert: "Protection auditive", count: 450 },
    { cert: "Ergonomie bureau", count: 380 },
    { cert: "SIMDUT avancÃ©", count: 320 },
    { cert: "HygiÃ¨ne alimentaire", count: 280 },
    { cert: "Protection respiratoire", count: 250 },
    { cert: "Radioprotection", count: 85 }
];

// ============================================================================
// PLOTLY CONFIGURATION
// ============================================================================

const plotlyLayout = {
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: { color: '#ffffff', family: 'Inter' },
    margin: { t: 40, r: 20, b: 60, l: 150 }
};

const plotlyConfig = {
    displayModeBar: false,
    responsive: true
};

// ============================================================================
// RENDERING FUNCTIONS
// ============================================================================

function showTab(tabName) {
    // Hide all content
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    // Remove active from all tabs
    document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('glass-card');
    });
    
    // Show selected content
    document.getElementById(`content-${tabName}`).classList.remove('hidden');
    // Activate tab
    const tab = document.getElementById(`tab-${tabName}`);
    tab.classList.add('tab-active');
    tab.classList.remove('glass-card');
    
    // Render charts for the tab
    renderCharts(tabName);
}

function renderCharts(tab) {
    switch(tab) {
        case 'overview':
            renderSectorsChart();
            renderZonesChart();
            renderRiskCategoriesChart();
            break;
        case 'sectors':
            renderSectorsGrid();
            renderEmployeesChart();
            break;
        case 'risks':
            renderRiskMatrix();
            renderRiskDistribution();
            renderRisksTable();
            break;
        case 'orgs':
            renderTopOrgsChart();
            break;
        case 'analytics':
            renderAgeChart();
            renderCertsChart();
            renderNetworkChart();
            break;
    }
}

function renderSectorsChart() {
    const data = [{
        type: 'bar',
        y: SECTEURS.map(s => s.nom),
        x: SECTEURS.map(s => s.orgs),
        orientation: 'h',
        marker: { color: SECTEURS.map(s => s.couleur) },
        text: SECTEURS.map(s => s.orgs),
        textposition: 'outside'
    }];
    
    Plotly.newPlot('chart-sectors', data, {
        ...plotlyLayout,
        xaxis: { title: 'Nombre d\'organisations', gridcolor: 'rgba(255,255,255,0.1)' },
        yaxis: { automargin: true }
    }, plotlyConfig);
}

function renderZonesChart() {
    const data = [{
        type: 'pie',
        values: ZONES_RISQUE.map(z => z.count),
        labels: ZONES_RISQUE.map(z => z.niveau.charAt(0).toUpperCase() + z.niveau.slice(1)),
        marker: { colors: ZONES_RISQUE.map(z => z.couleur) },
        hole: 0.4,
        textinfo: 'label+percent',
        textfont: { color: 'white' }
    }];
    
    Plotly.newPlot('chart-zones', data, {
        ...plotlyLayout,
        showlegend: true,
        legend: { orientation: 'h', y: -0.1 }
    }, plotlyConfig);
}

function renderRiskCategoriesChart() {
    const data = [{
        type: 'treemap',
        labels: CATEGORIES_RISQUE.map(c => c.cat),
        parents: CATEGORIES_RISQUE.map(() => ''),
        values: CATEGORIES_RISQUE.map(c => c.count),
        marker: {
            colors: CATEGORIES_RISQUE.map(c => c.score),
            colorscale: 'RdYlGn',
            reversescale: true,
            showscale: true,
            colorbar: { title: 'Score' }
        },
        textinfo: 'label+value',
        textfont: { size: 14 }
    }];
    
    Plotly.newPlot('chart-risk-categories', data, {
        ...plotlyLayout,
        margin: { t: 20, r: 20, b: 20, l: 20 }
    }, plotlyConfig);
}

function renderSectorsGrid() {
    const grid = document.getElementById('sectors-grid');
    grid.innerHTML = SECTEURS.map(s => `
        <div class="glass-card p-4 hover:scale-105 transition-transform cursor-pointer" 
             style="border-left: 4px solid ${s.couleur}">
            <div class="text-2xl mb-2">${s.nom.split(' ')[0]}</div>
            <div class="font-bold text-lg">${s.nom.substring(s.nom.indexOf(' ') + 1)}</div>
            <div class="text-gray-400 text-sm">SCIAN ${s.scian}</div>
            <div class="mt-3 flex justify-between">
                <div>
                    <div class="text-2xl font-bold text-cyan-400">${s.orgs}</div>
                    <div class="text-xs text-gray-400">Orgs</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-green-400">${(s.employes/1000).toFixed(0)}k</div>
                    <div class="text-xs text-gray-400">EmployÃ©s</div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderEmployeesChart() {
    const data = [{
        type: 'bar',
        x: SECTEURS.map(s => s.nom),
        y: SECTEURS.map(s => s.employes),
        marker: { color: SECTEURS.map(s => s.couleur) },
        text: SECTEURS.map(s => `${(s.employes/1000).toFixed(0)}k`),
        textposition: 'outside'
    }];
    
    Plotly.newPlot('chart-employees', data, {
        ...plotlyLayout,
        xaxis: { tickangle: -45 },
        yaxis: { title: 'Nombre d\'employÃ©s' },
        margin: { ...plotlyLayout.margin, b: 150 }
    }, plotlyConfig);
}

function renderRiskMatrix() {
    const data = [{
        type: 'scatter',
        mode: 'markers',
        x: RISQUES_TZ.map(r => r.p),
        y: RISQUES_TZ.map(r => r.g),
        marker: {
            size: RISQUES_TZ.map(r => r.score * 2),
            color: RISQUES_TZ.map(r => r.score),
            colorscale: 'RdYlGn',
            reversescale: true,
            showscale: true,
            colorbar: { title: 'Score' }
        },
        text: RISQUES_TZ.map(r => r.desc),
        hovertemplate: '%{text}<br>P: %{x}, G: %{y}<extra></extra>'
    }];
    
    Plotly.newPlot('chart-risk-matrix', data, {
        ...plotlyLayout,
        xaxis: { title: 'ProbabilitÃ©', range: [0, 6], dtick: 1 },
        yaxis: { title: 'GravitÃ©', range: [0, 6], dtick: 1 },
        margin: { ...plotlyLayout.margin, l: 60 }
    }, plotlyConfig);
}

function renderRiskDistribution() {
    const scores = RISQUES_TZ.map(r => r.score);
    const data = [{
        type: 'histogram',
        x: scores,
        marker: { color: '#00d4ff' },
        nbinsx: 10
    }];
    
    Plotly.newPlot('chart-risk-dist', data, {
        ...plotlyLayout,
        xaxis: { title: 'Score (P Ã— G)' },
        yaxis: { title: 'Nombre de risques' },
        margin: { ...plotlyLayout.margin, l: 60 }
    }, plotlyConfig);
}

function renderRisksTable() {
    const tbody = document.getElementById('risks-tbody');
    tbody.innerHTML = RISQUES_TZ.map(r => `
        <tr class="border-b border-white/5 hover:bg-white/5">
            <td class="py-3 px-4">${r.desc}</td>
            <td class="py-3 px-4">
                <span class="sector-badge bg-orange-500/20 text-orange-400">${r.cat}</span>
            </td>
            <td class="py-3 px-4 text-center">${r.p}</td>
            <td class="py-3 px-4 text-center">${r.g}</td>
            <td class="py-3 px-4 text-center">
                <span class="font-bold ${r.score >= 15 ? 'text-red-400' : 'text-orange-400'}">${r.score}</span>
            </td>
        </tr>
    `).join('');
}

function renderTopOrgsChart() {
    const data = [{
        type: 'bar',
        y: TOP_ORGS.map(o => o.nom),
        x: TOP_ORGS.map(o => o.employes),
        orientation: 'h',
        marker: { 
            color: TOP_ORGS.map(o => {
                const secteur = SECTEURS.find(s => s.scian === o.secteur);
                return secteur ? secteur.couleur : '#00d4ff';
            })
        },
        text: TOP_ORGS.map(o => `${(o.employes/1000).toFixed(1)}k`),
        textposition: 'outside'
    }];
    
    Plotly.newPlot('chart-top-orgs', data, {
        ...plotlyLayout,
        xaxis: { title: 'Nombre d\'employÃ©s' },
        yaxis: { automargin: true },
        margin: { ...plotlyLayout.margin, l: 200 }
    }, plotlyConfig);
}

function renderAgeChart() {
    const data = [{
        type: 'bar',
        x: AGE_DISTRIBUTION.map(a => a.age),
        y: AGE_DISTRIBUTION.map(a => a.count),
        marker: { 
            color: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7']
        },
        text: AGE_DISTRIBUTION.map(a => a.count),
        textposition: 'outside'
    }];
    
    Plotly.newPlot('chart-age', data, {
        ...plotlyLayout,
        xaxis: { title: 'Groupe d\'Ã¢ge' },
        yaxis: { title: 'Nombre de personnes' },
        margin: { ...plotlyLayout.margin, l: 60 }
    }, plotlyConfig);
}

function renderCertsChart() {
    const data = [{
        type: 'bar',
        y: CERTIFICATIONS.map(c => c.cert),
        x: CERTIFICATIONS.map(c => c.count),
        orientation: 'h',
        marker: { 
            color: CERTIFICATIONS.map((_, i) => `hsl(${120 + i * 15}, 70%, 50%)`)
        }
    }];
    
    Plotly.newPlot('chart-certs', data, {
        ...plotlyLayout,
        xaxis: { title: 'Nombre' },
        yaxis: { automargin: true },
        margin: { ...plotlyLayout.margin, l: 180 }
    }, plotlyConfig);
}

function renderNetworkChart() {
    const data = [{
        type: 'scatter',
        mode: 'markers',
        x: SECTEURS.map((_, i) => Math.cos(i * 2 * Math.PI / SECTEURS.length) * 100),
        y: SECTEURS.map((_, i) => Math.sin(i * 2 * Math.PI / SECTEURS.length) * 100),
        marker: {
            size: SECTEURS.map(s => Math.sqrt(s.orgs) * 8),
            color: SECTEURS.map(s => s.couleur),
            line: { width: 2, color: 'white' }
        },
        text: SECTEURS.map(s => `${s.nom}<br>${s.orgs} orgs`),
        hoverinfo: 'text'
    }];
    
    Plotly.newPlot('chart-network', data, {
        ...plotlyLayout,
        xaxis: { visible: false, range: [-150, 150] },
        yaxis: { visible: false, range: [-150, 150] },
        margin: { t: 20, r: 20, b: 20, l: 20 }
    }, plotlyConfig);
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    // Update date
    document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('fr-CA', {
        year: 'numeric', month: 'long', day: 'numeric'
    });
    
    // Render initial charts
    renderCharts('overview');
    
    // Initialize Lucide icons
    lucide.createIcons();
});
</script>

</body>
</html>

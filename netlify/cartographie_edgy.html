<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Cartographie EDGY - SafetyGraph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        code, pre { font-family: 'JetBrains Mono', monospace; }
        
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .entity-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .entity-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        
        .entity-card.selected {
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 14px;
            color: white;
            width: 100%;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        
        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 40px;
        }
        
        .tab-btn.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }
        
        .json-preview {
            background: #1e1e2e;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected { background: #22c55e; }
        .status-disconnected { background: #ef4444; }
        .status-loading { background: #eab308; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .toast-success { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .toast-info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="text-white p-4 md:p-8">

    <!-- Header -->
    <header class="text-center mb-8">
        <div class="text-5xl mb-4">üó∫Ô∏è</div>
        <h1 class="text-3xl md:text-4xl font-bold mb-2">
            <span class="gradient-text">Cartographie EDGY</span>
        </h1>
        <p class="text-gray-400">
            Cr√©ez la structure organisationnelle SST et injectez directement dans Neo4j
        </p>
        <div class="flex justify-center gap-4 mt-4">
            <a href="index.html" class="text-cyan-400 hover:text-cyan-300 text-sm">‚Üê Retour SafetyGraph</a>
        </div>
        
        <!-- API Status -->
        <div class="mt-4 inline-flex items-center gap-2 bg-white/5 px-4 py-2 rounded-full">
            <span class="status-dot" id="apiStatusDot"></span>
            <span class="text-sm" id="apiStatusText">V√©rification API...</span>
            <button onclick="checkApiStatus()" class="text-cyan-400 hover:text-cyan-300 text-xs ml-2">üîÑ</button>
        </div>
    </header>

    <div class="max-w-7xl mx-auto">
        
        <!-- API Configuration -->
        <div class="glass-card p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-400">üîå API URL:</span>
                    <input type="text" id="apiUrl" value="http://localhost:8002" 
                           class="form-input w-64 text-sm" placeholder="http://localhost:8002">
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-400" id="neo4jStats">-</span>
                </div>
            </div>
        </div>
        
        <!-- Entit√©s EDGY -->
        <div class="glass-card p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="bg-cyan-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                S√©lectionnez le type d'entit√© √† cr√©er
            </h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3" id="entityTypes">
                <div class="entity-card glass-card p-4 text-center" data-entity="organization" onclick="selectEntity('organization')">
                    <div class="text-3xl mb-2">üè¢</div>
                    <div class="font-semibold text-sm">Organisation</div>
                    <div class="text-xs text-gray-400">Entreprise</div>
                </div>
                <div class="entity-card glass-card p-4 text-center" data-entity="zone" onclick="selectEntity('zone')">
                    <div class="text-3xl mb-2">üìç</div>
                    <div class="font-semibold text-sm">Zone</div>
                    <div class="text-xs text-gray-400">Lieu de travail</div>
                </div>
                <div class="entity-card glass-card p-4 text-center" data-entity="team" onclick="selectEntity('team')">
                    <div class="text-3xl mb-2">üë•</div>
                    <div class="font-semibold text-sm">√âquipe</div>
                    <div class="text-xs text-gray-400">Groupe</div>
                </div>
                <div class="entity-card glass-card p-4 text-center" data-entity="role" onclick="selectEntity('role')">
                    <div class="text-3xl mb-2">üë§</div>
                    <div class="font-semibold text-sm">R√¥le</div>
                    <div class="text-xs text-gray-400">Fonction</div>
                </div>
                <div class="entity-card glass-card p-4 text-center" data-entity="person" onclick="selectEntity('person')">
                    <div class="text-3xl mb-2">üßë‚Äçüíº</div>
                    <div class="font-semibold text-sm">Personne</div>
                    <div class="text-xs text-gray-400">Travailleur</div>
                </div>
                <div class="entity-card glass-card p-4 text-center" data-entity="risk" onclick="selectEntity('risk')">
                    <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                    <div class="font-semibold text-sm">Risque</div>
                    <div class="text-xs text-gray-400">Danger</div>
                </div>
                <div class="entity-card glass-card p-4 text-center" data-entity="process" onclick="selectEntity('process')">
                    <div class="text-3xl mb-2">‚öôÔ∏è</div>
                    <div class="font-semibold text-sm">Processus</div>
                    <div class="text-xs text-gray-400">Activit√©</div>
                </div>
            </div>
        </div>

        <!-- Formulaire dynamique -->
        <div class="glass-card p-6 mb-6" id="formSection" style="display: none;">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="bg-cyan-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                <span id="formTitle">Cr√©er une entit√©</span>
            </h2>
            
            <div id="formContainer" class="grid md:grid-cols-2 gap-4">
                <!-- Formulaire g√©n√©r√© dynamiquement -->
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="addEntity()" 
                        class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center gap-2">
                    <span>‚ûï</span> Ajouter √† la liste
                </button>
                <button onclick="clearForm()" 
                        class="bg-white/10 hover:bg-white/20 text-white py-3 px-6 rounded-lg transition-all">
                    üóëÔ∏è Effacer
                </button>
            </div>
        </div>

        <!-- Cartographie cr√©√©e -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            
            <!-- Liste des entit√©s -->
            <div class="glass-card p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">3</span>
                    Entit√©s √† injecter
                    <span class="text-gray-400 font-normal text-sm ml-2" id="entityCount">(0)</span>
                </h2>
                
                <div id="entityList" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-sm italic">Aucune entit√© cr√©√©e</p>
                </div>
            </div>
            
            <!-- Actions Neo4j -->
            <div class="glass-card p-6">
                <h2 class="text-xl font-bold mb-4">üî∑ Injection Neo4j</h2>
                
                <div class="space-y-4">
                    <!-- Bouton principal -->
                    <button onclick="injectToNeo4j()" id="injectBtn"
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 text-white font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>üöÄ</span>
                        <span>Envoyer √† Neo4j</span>
                    </button>
                    
                    <p class="text-gray-500 text-xs text-center">
                        Injecte toutes les entit√©s via l'API SafetyGraph
                    </p>
                    
                    <!-- R√©sultat -->
                    <div id="injectionResult" class="hidden">
                        <div class="bg-white/5 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">üìä R√©sultat de l'injection</h4>
                            <div id="injectionDetails" class="text-sm text-gray-400"></div>
                        </div>
                    </div>
                    
                    <!-- Actions secondaires -->
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="copyJSON()" 
                                class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                            üìã Copier JSON
                        </button>
                        <button onclick="downloadJSON()" 
                                class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                            üíæ T√©l√©charger
                        </button>
                    </div>
                    
                    <button onclick="clearAll()" 
                            class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 px-4 rounded-lg text-sm mt-2">
                        üóëÔ∏è Vider la liste
                    </button>
                </div>
            </div>
            
        </div>

        <!-- Preview JSON -->
        <div class="glass-card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">üìÑ Aper√ßu JSON</h2>
                <span class="text-gray-500 text-sm" id="jsonSize">0 octets</span>
            </div>
            
            <div class="json-preview p-4">
                <pre><code id="exportCode" class="text-green-400 text-sm">{
  "organizations": [],
  "zones": [],
  "teams": [],
  "roles": [],
  "persons": [],
  "risks": [],
  "processes": []
}</code></pre>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="text-center py-8 mt-8 text-gray-500 text-sm">
        <p>üõ°Ô∏è SafetyGraph | EDGY-AgenticX5 | Preventera | GenAISafety</p>
        <p class="mt-1">Donn√©es conformes √† la Loi 25 du Qu√©bec</p>
    </footer>

    <!-- Toast container -->
    <div id="toastContainer"></div>

<script>
// ============================================================================
// CONFIGURATION API
// ============================================================================

let API_URL = 'http://localhost:8002';
let apiConnected = false;

// ============================================================================
// DONN√âES
// ============================================================================

let selectedEntityType = null;
let cartography = {
    organizations: [],
    zones: [],
    teams: [],
    roles: [],
    persons: [],
    risks: [],
    processes: []
};

// Configuration des formulaires par type d'entit√©
const ENTITY_FORMS = {
    organization: {
        title: "üè¢ Cr√©er une Organisation",
        fields: [
            { name: "name", label: "Nom de l'entreprise", type: "text", required: true, placeholder: "Ex: Industries ABC Inc." },
            { name: "sector_scian", label: "Secteur SCIAN", type: "select", required: true, options: [
                { value: "", label: "-- S√©lectionner --" },
                { value: "236", label: "236 - Construction b√¢timents" },
                { value: "237", label: "237 - G√©nie civil" },
                { value: "238", label: "238 - Entrepreneurs sp√©cialis√©s" },
                { value: "31-33", label: "31-33 - Fabrication" },
                { value: "311", label: "311 - Agroalimentaire" },
                { value: "44-45", label: "44-45 - Commerce d√©tail" },
                { value: "48-49", label: "48-49 - Transport/Entreposage" },
                { value: "54", label: "54 - Services professionnels" },
                { value: "62", label: "62 - Sant√©" },
                { value: "72", label: "72 - H√©bergement/Restauration" },
                { value: "21", label: "21 - Mines" },
                { value: "22", label: "22 - Services publics" },
                { value: "11", label: "11 - Agriculture" },
                { value: "91", label: "91 - Administration publique" }
            ]},
            { name: "nb_employes", label: "Nombre d'employ√©s", type: "number", placeholder: "Ex: 150" },
            { name: "region_ssq", label: "R√©gion SSQ", type: "select", options: [
                { value: "", label: "-- S√©lectionner --" },
                { value: "Montreal", label: "Montr√©al" },
                { value: "Quebec", label: "Qu√©bec" },
                { value: "Laval", label: "Laval" },
                { value: "Monteregie", label: "Mont√©r√©gie" },
                { value: "Laurentides", label: "Laurentides" },
                { value: "Lanaudiere", label: "Lanaudi√®re" },
                { value: "Estrie", label: "Estrie" },
                { value: "Mauricie", label: "Mauricie" },
                { value: "Saguenay", label: "Saguenay-Lac-St-Jean" },
                { value: "Outaouais", label: "Outaouais" },
                { value: "Abitibi", label: "Abitibi-T√©miscamingue" },
                { value: "CoteNord", label: "C√¥te-Nord" },
                { value: "ChaudiereAppalaches", label: "Chaudi√®re-Appalaches" }
            ]},
            { name: "code_cnesst", label: "Code CNESST (optionnel)", type: "text", placeholder: "Ex: CNESST-12345" }
        ]
    },
    zone: {
        title: "üìç Cr√©er une Zone",
        fields: [
            { name: "name", label: "Nom de la zone", type: "text", required: true, placeholder: "Ex: Atelier de production" },
            { name: "risk_level", label: "Niveau de risque", type: "select", required: true, options: [
                { value: "", label: "-- S√©lectionner --" },
                { value: "minimal", label: "üü¢ Minimal" },
                { value: "faible", label: "üü° Faible" },
                { value: "moyen", label: "üü† Moyen" },
                { value: "eleve", label: "üî¥ √âlev√©" },
                { value: "critique", label: "‚ö´ Critique" }
            ]},
            { name: "dangers_identifies", label: "Dangers identifi√©s (s√©par√©s par virgule)", type: "text", placeholder: "Ex: Bruit, Machines, Manutention" },
            { name: "epi_requis", label: "EPI requis (s√©par√©s par virgule)", type: "text", placeholder: "Ex: Casque, Lunettes, Gants" },
            { name: "capacite_max", label: "Capacit√© max (personnes)", type: "number", placeholder: "Ex: 20" }
        ]
    },
    team: {
        title: "üë• Cr√©er une √âquipe",
        fields: [
            { name: "name", label: "Nom de l'√©quipe", type: "text", required: true, placeholder: "Ex: √âquipe Production A" },
            { name: "department", label: "D√©partement", type: "text", placeholder: "Ex: Production" },
            { name: "shift", label: "Quart de travail", type: "select", options: [
                { value: "", label: "-- S√©lectionner --" },
                { value: "jour", label: "üåÖ Jour" },
                { value: "soir", label: "üåÜ Soir" },
                { value: "nuit", label: "üåô Nuit" },
                { value: "rotation", label: "üîÑ Rotation" }
            ]},
            { name: "superviseur", label: "Superviseur", type: "text", placeholder: "Ex: Jean Tremblay" }
        ]
    },
    role: {
        title: "üë§ Cr√©er un R√¥le",
        fields: [
            { name: "name", label: "Titre du r√¥le", type: "text", required: true, placeholder: "Ex: Op√©rateur de machine" },
            { name: "niveau_hierarchique", label: "Niveau hi√©rarchique", type: "select", options: [
                { value: "1", label: "1 - Op√©rationnel" },
                { value: "2", label: "2 - Technicien" },
                { value: "3", label: "3 - Superviseur" },
                { value: "4", label: "4 - Gestionnaire" },
                { value: "5", label: "5 - Direction" }
            ]},
            { name: "formations_obligatoires", label: "Formations obligatoires (virgule)", type: "text", placeholder: "Ex: SIMDUT, Secourisme, LOTO" },
            { name: "autorite_arret_travail", label: "Autorit√© arr√™t travail", type: "select", options: [
                { value: "false", label: "‚ùå Non" },
                { value: "true", label: "‚úÖ Oui" }
            ]}
        ]
    },
    person: {
        title: "üßë‚Äçüíº Cr√©er une Personne",
        fields: [
            { name: "matricule", label: "Matricule (anonyme)", type: "text", required: true, placeholder: "Ex: EMP-001" },
            { name: "department", label: "D√©partement", type: "text", placeholder: "Ex: Production" },
            { name: "age_groupe", label: "Groupe d'√¢ge", type: "select", options: [
                { value: "", label: "-- S√©lectionner --" },
                { value: "18-24", label: "18-24 ans" },
                { value: "25-34", label: "25-34 ans" },
                { value: "35-44", label: "35-44 ans" },
                { value: "45-54", label: "45-54 ans" },
                { value: "55-64", label: "55-64 ans" },
                { value: "65+", label: "65+ ans" }
            ]},
            { name: "anciennete_annees", label: "Anciennet√© (ann√©es)", type: "number", placeholder: "Ex: 5" },
            { name: "certifications_sst", label: "Certifications SST (virgule)", type: "text", placeholder: "Ex: SIMDUT, Secourisme, Cariste" }
        ]
    },
    risk: {
        title: "‚ö†Ô∏è Cr√©er un Risque",
        fields: [
            { name: "description", label: "Description du risque", type: "text", required: true, placeholder: "Ex: Risque de coupure sur machine X" },
            { name: "categorie", label: "Cat√©gorie", type: "select", required: true, options: [
                { value: "", label: "-- S√©lectionner --" },
                { value: "chute", label: "ü™ú Chute" },
                { value: "mecanique", label: "üîß M√©canique" },
                { value: "electrique", label: "‚ö° √âlectrique" },
                { value: "ergonomique", label: "ü¶¥ Ergonomique" },
                { value: "chimique", label: "üß™ Chimique" },
                { value: "biologique", label: "ü¶† Biologique" },
                { value: "psychosocial", label: "üß† Psychosocial" },
                { value: "bruit", label: "üîä Bruit" },
                { value: "thermique", label: "üî• Thermique" },
                { value: "radiation", label: "‚ò¢Ô∏è Radiation" }
            ]},
            { name: "probabilite", label: "Probabilit√© (1-5)", type: "select", required: true, options: [
                { value: "1", label: "1 - Rare" },
                { value: "2", label: "2 - Peu probable" },
                { value: "3", label: "3 - Possible" },
                { value: "4", label: "4 - Probable" },
                { value: "5", label: "5 - Tr√®s probable" }
            ]},
            { name: "gravite", label: "Gravit√© (1-5)", type: "select", required: true, options: [
                { value: "1", label: "1 - N√©gligeable" },
                { value: "2", label: "2 - Mineur" },
                { value: "3", label: "3 - Mod√©r√©" },
                { value: "4", label: "4 - Majeur" },
                { value: "5", label: "5 - Catastrophique" }
            ]},
            { name: "controles", label: "Mesures de contr√¥le", type: "text", placeholder: "Ex: Garde de protection, Formation" }
        ]
    },
    process: {
        title: "‚öôÔ∏è Cr√©er un Processus",
        fields: [
            { name: "name", label: "Nom du processus", type: "text", required: true, placeholder: "Ex: Assemblage pi√®ces" },
            { name: "description", label: "Description", type: "text", placeholder: "Ex: Processus d'assemblage en ligne" },
            { name: "criticite", label: "Criticit√©", type: "select", options: [
                { value: "faible", label: "üü¢ Faible" },
                { value: "moyenne", label: "üü° Moyenne" },
                { value: "elevee", label: "üî¥ √âlev√©e" }
            ]},
            { name: "frequence", label: "Fr√©quence", type: "select", options: [
                { value: "continue", label: "Continue" },
                { value: "quotidienne", label: "Quotidienne" },
                { value: "hebdomadaire", label: "Hebdomadaire" },
                { value: "mensuelle", label: "Mensuelle" },
                { value: "occasionnelle", label: "Occasionnelle" }
            ]}
        ]
    }
};

// ============================================================================
// API FUNCTIONS
// ============================================================================

async function checkApiStatus() {
    const dot = document.getElementById('apiStatusDot');
    const text = document.getElementById('apiStatusText');
    const statsEl = document.getElementById('neo4jStats');
    
    API_URL = document.getElementById('apiUrl').value;
    
    dot.className = 'status-dot status-loading';
    text.textContent = 'Connexion...';
    
    try {
        const response = await fetch(`${API_URL}/health`);
        const data = await response.json();
        
        if (data.neo4j === 'connected') {
            apiConnected = true;
            dot.className = 'status-dot status-connected';
            text.textContent = `Connect√© √† Neo4j`;
            
            // Get stats
            const statsResp = await fetch(`${API_URL}/api/v1/stats`);
            const stats = await statsResp.json();
            statsEl.textContent = `${stats.organizations} orgs | ${stats.risks} risques`;
            
            showToast('‚úÖ API connect√©e !', 'success');
        } else {
            throw new Error('Neo4j disconnected');
        }
    } catch (error) {
        apiConnected = false;
        dot.className = 'status-dot status-disconnected';
        text.textContent = 'API non disponible';
        statsEl.textContent = '-';
        showToast('‚ùå API non disponible', 'error');
    }
}

async function injectToNeo4j() {
    if (!apiConnected) {
        showToast('‚ùå API non connect√©e !', 'error');
        return;
    }
    
    const totalEntities = Object.values(cartography).reduce((sum, arr) => sum + arr.length, 0);
    if (totalEntities === 0) {
        showToast('‚ö†Ô∏è Aucune entit√© √† injecter', 'info');
        return;
    }
    
    const btn = document.getElementById('injectBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-pulse">‚è≥ Injection en cours...</span>';
    
    try {
        const response = await fetch(`${API_URL}/api/v1/cartography/import`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cartography)
        });
        
        const result = await response.json();
        
        if (result.success) {
            const imported = result.imported;
            const total = Object.values(imported).reduce((sum, n) => sum + n, 0);
            
            showToast(`‚úÖ ${total} entit√©s inject√©es dans Neo4j !`, 'success');
            
            // Show details
            document.getElementById('injectionResult').classList.remove('hidden');
            document.getElementById('injectionDetails').innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div>üè¢ Organisations: <span class="text-green-400">${imported.organizations}</span></div>
                    <div>üìç Zones: <span class="text-green-400">${imported.zones}</span></div>
                    <div>üë• √âquipes: <span class="text-green-400">${imported.teams}</span></div>
                    <div>üë§ R√¥les: <span class="text-green-400">${imported.roles}</span></div>
                    <div>üßë‚Äçüíº Personnes: <span class="text-green-400">${imported.persons}</span></div>
                    <div>‚ö†Ô∏è Risques: <span class="text-green-400">${imported.risks}</span></div>
                </div>
                <p class="text-green-400 mt-2 font-semibold">‚úÖ Total: ${total} entit√©s</p>
            `;
            
            // Refresh stats
            checkApiStatus();
        } else {
            throw new Error(result.error || 'Erreur inconnue');
        }
    } catch (error) {
        showToast(`‚ùå Erreur: ${error.message}`, 'error');
    }
    
    btn.disabled = false;
    btn.innerHTML = '<span>üöÄ</span><span>Envoyer √† Neo4j</span>';
}

// ============================================================================
// UI FUNCTIONS
// ============================================================================

function selectEntity(type) {
    selectedEntityType = type;
    
    document.querySelectorAll('.entity-card').forEach(card => {
        card.classList.remove('selected');
        if (card.dataset.entity === type) {
            card.classList.add('selected');
        }
    });
    
    renderForm(type);
    document.getElementById('formSection').style.display = 'block';
}

function renderForm(type) {
    const config = ENTITY_FORMS[type];
    document.getElementById('formTitle').textContent = config.title;
    
    const container = document.getElementById('formContainer');
    container.innerHTML = config.fields.map(field => {
        let input;
        
        if (field.type === 'select') {
            input = `
                <select id="field_${field.name}" class="form-input" ${field.required ? 'required' : ''}>
                    ${field.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                </select>
            `;
        } else {
            input = `
                <input type="${field.type}" id="field_${field.name}" class="form-input" 
                       placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>
            `;
        }
        
        return `
            <div>
                <label class="block text-sm text-gray-400 mb-2">${field.label}${field.required ? ' *' : ''}</label>
                ${input}
            </div>
        `;
    }).join('');
}

function addEntity() {
    if (!selectedEntityType) return;
    
    const config = ENTITY_FORMS[selectedEntityType];
    const entity = {
        id: `${selectedEntityType.toUpperCase()}-${Date.now().toString(36)}`
    };
    
    config.fields.forEach(field => {
        const el = document.getElementById(`field_${field.name}`);
        let value = el.value;
        
        if (field.type === 'number' && value) {
            value = parseInt(value);
        }
        if (field.name.includes('formations') || field.name.includes('certifications') || field.name.includes('dangers') || field.name.includes('epi')) {
            value = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
        }
        if (value === 'true') value = true;
        if (value === 'false') value = false;
        
        if (value !== '' && value !== null && !(Array.isArray(value) && value.length === 0)) {
            entity[field.name] = value;
        }
    });
    
    if (selectedEntityType === 'risk' && entity.probabilite && entity.gravite) {
        entity.score = parseInt(entity.probabilite) * parseInt(entity.gravite);
    }
    
    const pluralType = selectedEntityType === 'process' ? 'processes' : selectedEntityType + 's';
    cartography[pluralType].push(entity);
    
    updateEntityList();
    updateExport();
    clearForm();
    
    showToast(`‚úÖ ${config.title.split(' ')[1]} ajout√©(e) !`, 'success');
}

function clearForm() {
    const config = ENTITY_FORMS[selectedEntityType];
    if (!config) return;
    
    config.fields.forEach(field => {
        const el = document.getElementById(`field_${field.name}`);
        if (el) el.value = '';
    });
}

function clearAll() {
    cartography = {
        organizations: [],
        zones: [],
        teams: [],
        roles: [],
        persons: [],
        risks: [],
        processes: []
    };
    updateEntityList();
    updateExport();
    document.getElementById('injectionResult').classList.add('hidden');
    showToast('üóëÔ∏è Liste vid√©e', 'info');
}

function updateEntityList() {
    const container = document.getElementById('entityList');
    const allEntities = [];
    
    Object.keys(cartography).forEach(type => {
        cartography[type].forEach(entity => {
            allEntities.push({ ...entity, _type: type });
        });
    });
    
    document.getElementById('entityCount').textContent = `(${allEntities.length})`;
    
    if (allEntities.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm italic">Aucune entit√© cr√©√©e</p>';
        return;
    }
    
    const icons = {
        organizations: 'üè¢', zones: 'üìç', teams: 'üë•', roles: 'üë§',
        persons: 'üßë‚Äçüíº', risks: '‚ö†Ô∏è', processes: '‚öôÔ∏è'
    };
    
    container.innerHTML = allEntities.map(entity => `
        <div class="flex items-center justify-between bg-white/5 rounded-lg p-3">
            <div class="flex items-center gap-3">
                <span class="text-xl">${icons[entity._type]}</span>
                <div>
                    <div class="font-medium text-sm">${entity.name || entity.description || entity.matricule}</div>
                    <div class="text-xs text-gray-500">${entity.id}</div>
                </div>
            </div>
            <button onclick="removeEntity('${entity._type}', '${entity.id}')" class="text-red-400 hover:text-red-300">
                üóëÔ∏è
            </button>
        </div>
    `).join('');
}

function removeEntity(type, id) {
    cartography[type] = cartography[type].filter(e => e.id !== id);
    updateEntityList();
    updateExport();
}

function updateExport() {
    const json = JSON.stringify(cartography, null, 2);
    document.getElementById('exportCode').textContent = json;
    document.getElementById('jsonSize').textContent = `${json.length} octets`;
}

function copyJSON() {
    navigator.clipboard.writeText(JSON.stringify(cartography, null, 2)).then(() => {
        showToast('üìã JSON copi√© !', 'success');
    });
}

function downloadJSON() {
    const data = JSON.stringify(cartography, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `cartographie_edgy_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    
    URL.revokeObjectURL(url);
    showToast('üíæ Fichier t√©l√©charg√© !', 'success');
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ============================================================================
// INIT
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    checkApiStatus();
    updateExport();
});
</script>

</body>
</html>

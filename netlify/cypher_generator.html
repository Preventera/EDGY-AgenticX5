<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß G√©n√©rateur Cypher SST - SafetyGraph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        code, pre { font-family: 'JetBrains Mono', monospace; }
        
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .glass-card:hover {
            border-color: rgba(0, 212, 255, 0.3);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sector-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sector-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        
        .sector-card.selected {
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }
        
        .code-block {
            background: #1e1e2e;
            border-radius: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .code-block::-webkit-scrollbar {
            width: 8px;
        }
        
        .code-block::-webkit-scrollbar-track {
            background: #1e1e2e;
        }
        
        .code-block::-webkit-scrollbar-thumb {
            background: #3b3b5c;
            border-radius: 4px;
        }
        
        .priority-critical { border-left: 4px solid #ef4444; }
        .priority-high { border-left: 4px solid #f97316; }
        .priority-medium { border-left: 4px solid #eab308; }
        
        .tab-btn.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }
        
        .copy-btn {
            transition: all 0.2s ease;
        }
        
        .copy-btn:hover {
            transform: scale(1.05);
        }
        
        .copy-btn.copied {
            background: #22c55e !important;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .generating {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body class="text-white p-4 md:p-8">

    <!-- Header -->
    <header class="text-center mb-8">
        <div class="text-5xl mb-4">üîß</div>
        <h1 class="text-3xl md:text-4xl font-bold mb-2">
            <span class="gradient-text">G√©n√©rateur Cypher SST</span>
        </h1>
        <p class="text-gray-400">
            G√©n√©rez automatiquement des requ√™tes Neo4j personnalis√©es selon le profil CNESST de votre secteur
        </p>
        <div class="flex justify-center gap-4 mt-4">
            <a href="index.html" class="text-cyan-400 hover:text-cyan-300 text-sm">‚Üê Retour SafetyGraph</a>
            <a href="https://github.com/Preventera/EDGY-AgenticX5" target="_blank" class="text-cyan-400 hover:text-cyan-300 text-sm">üìÇ GitHub</a>
        </div>
    </header>

    <div class="max-w-7xl mx-auto">
        
        <!-- Step 1: S√©lection du secteur -->
        <div class="glass-card p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="bg-cyan-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                S√©lectionnez votre secteur SCIAN
            </h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3" id="sectorsGrid">
                <!-- Secteurs g√©n√©r√©s par JS -->
            </div>
        </div>

        <!-- Step 2: Profil de risques -->
        <div class="glass-card p-6 mb-6" id="riskProfileSection" style="display: none;">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="bg-cyan-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                Profil de risques CNESST
                <span class="text-gray-400 font-normal text-base ml-2" id="selectedSectorName"></span>
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Statistiques -->
                <div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-white/5 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-400" id="lesionsCount">-</div>
                            <div class="text-gray-400 text-sm">L√©sions/an</div>
                        </div>
                        <div class="bg-white/5 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-cyan-400" id="risksCount">-</div>
                            <div class="text-gray-400 text-sm">Types de risques</div>
                        </div>
                    </div>
                    
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Certifications requises</h3>
                    <div class="flex flex-wrap gap-2 mb-4" id="certificationsList"></div>
                    
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">EPI critiques</h3>
                    <div class="flex flex-wrap gap-2" id="epiList"></div>
                </div>
                
                <!-- Risques prioritaires -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-300 mb-3">Risques prioritaires</h3>
                    <div class="space-y-2" id="risksList"></div>
                </div>
            </div>
        </div>

        <!-- Step 3: Options de g√©n√©ration -->
        <div class="glass-card p-6 mb-6" id="optionsSection" style="display: none;">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="bg-cyan-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">3</span>
                Options de g√©n√©ration
            </h2>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cat√©gories de requ√™tes</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="optDiagnostic" checked class="rounded bg-white/10 border-white/20">
                            <span class="text-sm">üìã Diagnostic initial</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="optRisques" checked class="rounded bg-white/10 border-white/20">
                            <span class="text-sm">‚ö†Ô∏è Analyse des risques</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="optAlertes" checked class="rounded bg-white/10 border-white/20">
                            <span class="text-sm">üö® Alertes proactives</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="optConformite" checked class="rounded bg-white/10 border-white/20">
                            <span class="text-sm">‚úÖ Conformit√© & audit</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="optAgents" checked class="rounded bg-white/10 border-white/20">
                            <span class="text-sm">ü§ñ Agents IA</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="optDashboard" checked class="rounded bg-white/10 border-white/20">
                            <span class="text-sm">üìä Dashboard</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Nom de l'organisation (optionnel)</label>
                    <input type="text" id="orgName" placeholder="Ex: Hydro-Qu√©bec" 
                           class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-cyan-500 focus:outline-none">
                    
                    <label class="block text-sm text-gray-400 mb-2 mt-4">Nombre d'employ√©s (optionnel)</label>
                    <input type="number" id="nbEmployes" placeholder="Ex: 500" 
                           class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-cyan-500 focus:outline-none">
                </div>
                
                <div class="flex flex-col justify-end">
                    <button onclick="generateCypher()" id="generateBtn"
                            class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
                        <span>‚ö°</span>
                        <span>G√©n√©rer les requ√™tes</span>
                    </button>
                    <p class="text-gray-500 text-xs text-center mt-2">~50 requ√™tes personnalis√©es</p>
                </div>
            </div>
        </div>

        <!-- Step 4: R√©sultats -->
        <div class="glass-card p-6" id="resultsSection" style="display: none;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">‚úì</span>
                    Requ√™tes g√©n√©r√©es
                    <span class="text-gray-400 font-normal text-base ml-2" id="queryCount"></span>
                </h2>
                
                <div class="flex gap-2">
                    <button onclick="copyAllCypher()" id="copyAllBtn"
                            class="copy-btn bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                        <span>üìã</span> Copier tout
                    </button>
                    <button onclick="downloadCypher()" 
                            class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                        <span>üíæ</span> T√©l√©charger .cypher
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex flex-wrap gap-2 mb-4" id="categoryTabs"></div>
            
            <!-- Code -->
            <div class="code-block p-4">
                <pre><code class="language-cypher" id="cypherCode"></code></pre>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="text-center py-8 mt-8 text-gray-500 text-sm">
        <p>üõ°Ô∏è SafetyGraph | EDGY-AgenticX5 | Preventera | GenAISafety</p>
        <p class="mt-1">Donn√©es bas√©es sur les profils CNESST du Qu√©bec</p>
    </footer>

<script>
// ============================================================================
// BASE DE DONN√âES DES PROFILS CNESST
// ============================================================================

const PROFILS_CNESST = {
    "236": {
        scian: "236",
        nom: "Construction de b√¢timents",
        nom_court: "Construction",
        emoji: "üèóÔ∏è",
        lesions_annuelles: 18000,
        risques_prioritaires: [
            { categorie: "chute", pct: 28, priorite: "CRITIQUE", emoji: "ü™ú" },
            { categorie: "mecanique", pct: 22, priorite: "CRITIQUE", emoji: "üîß" },
            { categorie: "electrique", pct: 12, priorite: "CRITIQUE", emoji: "‚ö°" },
            { categorie: "ergonomique", pct: 18, priorite: "ELEVE", emoji: "ü¶¥" },
            { categorie: "bruit", pct: 8, priorite: "MOYEN", emoji: "üîä" },
            { categorie: "chimique", pct: 7, priorite: "ELEVE", emoji: "üß™" },
            { categorie: "thermique", pct: 5, priorite: "MOYEN", emoji: "‚òÄÔ∏è" }
        ],
        certifications: ["ASP Construction", "Travail en hauteur", "LOTO", "SIMDUT", "Premiers soins"],
        epi: ["casque", "harnais", "lunettes", "gants", "bottes", "gilet"],
        mots_cles: ["chute", "hauteur", "√©chafaud", "√©chelle", "excavation", "grue", "√©lectrique"]
    },
    "621": {
        scian: "621",
        nom: "Services de soins ambulatoires",
        nom_court: "Soins ambulatoires",
        emoji: "üè•",
        lesions_annuelles: 25000,
        risques_prioritaires: [
            { categorie: "ergonomique", pct: 35, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "biologique", pct: 25, priorite: "CRITIQUE", emoji: "ü¶†" },
            { categorie: "psychosocial", pct: 20, priorite: "ELEVE", emoji: "üß†" },
            { categorie: "chimique", pct: 10, priorite: "ELEVE", emoji: "üß™" },
            { categorie: "chute", pct: 5, priorite: "MOYEN", emoji: "ü™ú" },
            { categorie: "violence", pct: 5, priorite: "ELEVE", emoji: "‚ö†Ô∏è" }
        ],
        certifications: ["SIMDUT", "Premiers soins", "RCR", "PDSB", "Pr√©vention infections"],
        epi: ["gants", "masque", "blouse", "lunettes", "√©cran facial"],
        mots_cles: ["manutention patient", "piq√ªre", "infection", "stress", "agression"]
    },
    "622": {
        scian: "622",
        nom: "H√¥pitaux",
        nom_court: "H√¥pitaux",
        emoji: "üè®",
        lesions_annuelles: 35000,
        risques_prioritaires: [
            { categorie: "ergonomique", pct: 40, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "biologique", pct: 22, priorite: "CRITIQUE", emoji: "ü¶†" },
            { categorie: "psychosocial", pct: 18, priorite: "ELEVE", emoji: "üß†" },
            { categorie: "chimique", pct: 8, priorite: "ELEVE", emoji: "üß™" },
            { categorie: "violence", pct: 7, priorite: "ELEVE", emoji: "‚ö†Ô∏è" },
            { categorie: "radiation", pct: 5, priorite: "ELEVE", emoji: "‚ò¢Ô∏è" }
        ],
        certifications: ["SIMDUT", "PDSB", "RCR", "Pr√©vention infections", "Radioprotection"],
        epi: ["gants", "masque N95", "blouse", "lunettes", "tablier plomb√©"],
        mots_cles: ["patient", "civi√®re", "piq√ªre", "sang", "chimio", "radiation"]
    },
    "31": {
        scian: "31",
        nom: "Fabrication d'aliments",
        nom_court: "Agroalimentaire",
        emoji: "üçñ",
        lesions_annuelles: 12000,
        risques_prioritaires: [
            { categorie: "ergonomique", pct: 30, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "mecanique", pct: 25, priorite: "CRITIQUE", emoji: "üîß" },
            { categorie: "chute", pct: 15, priorite: "ELEVE", emoji: "ü™ú" },
            { categorie: "thermique", pct: 12, priorite: "ELEVE", emoji: "üî•" },
            { categorie: "chimique", pct: 10, priorite: "MOYEN", emoji: "üß™" },
            { categorie: "bruit", pct: 8, priorite: "MOYEN", emoji: "üîä" }
        ],
        certifications: ["SIMDUT", "LOTO", "Hygi√®ne alimentaire", "Cariste", "Premiers soins"],
        epi: ["gants", "tablier", "bottes antid√©rapantes", "r√©sille", "protecteurs auditifs"],
        mots_cles: ["coupure", "br√ªlure", "froid", "manutention", "convoyeur", "trancheuse"]
    },
    "32": {
        scian: "32",
        nom: "Fabrication de produits",
        nom_court: "Fabrication",
        emoji: "üè≠",
        lesions_annuelles: 20000,
        risques_prioritaires: [
            { categorie: "mecanique", pct: 30, priorite: "CRITIQUE", emoji: "üîß" },
            { categorie: "ergonomique", pct: 25, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "chimique", pct: 15, priorite: "ELEVE", emoji: "üß™" },
            { categorie: "bruit", pct: 12, priorite: "ELEVE", emoji: "üîä" },
            { categorie: "chute", pct: 10, priorite: "MOYEN", emoji: "ü™ú" },
            { categorie: "electrique", pct: 8, priorite: "ELEVE", emoji: "‚ö°" }
        ],
        certifications: ["SIMDUT", "LOTO", "Cariste", "Pont roulant", "Premiers soins"],
        epi: ["lunettes", "gants", "protecteurs auditifs", "chaussures s√©curit√©", "casque"],
        mots_cles: ["machine", "presse", "coincement", "√©crasement", "solvant", "poussi√®re"]
    },
    "33": {
        scian: "33",
        nom: "Fabrication machines/m√©taux",
        nom_court: "M√©tallurgie",
        emoji: "‚öôÔ∏è",
        lesions_annuelles: 13000,
        risques_prioritaires: [
            { categorie: "mecanique", pct: 35, priorite: "CRITIQUE", emoji: "üîß" },
            { categorie: "ergonomique", pct: 20, priorite: "ELEVE", emoji: "ü¶¥" },
            { categorie: "bruit", pct: 15, priorite: "ELEVE", emoji: "üîä" },
            { categorie: "chimique", pct: 12, priorite: "ELEVE", emoji: "üß™" },
            { categorie: "thermique", pct: 10, priorite: "ELEVE", emoji: "üî•" },
            { categorie: "electrique", pct: 8, priorite: "ELEVE", emoji: "‚ö°" }
        ],
        certifications: ["SIMDUT", "LOTO", "Soudage", "Pont roulant", "Cariste"],
        epi: ["lunettes", "masque soudeur", "gants", "tablier cuir", "protecteurs auditifs"],
        mots_cles: ["soudure", "meulage", "tour", "presse", "m√©tal chaud", "fum√©es"]
    },
    "44": {
        scian: "44",
        nom: "Commerce de d√©tail",
        nom_court: "Commerce",
        emoji: "üõí",
        lesions_annuelles: 25000,
        risques_prioritaires: [
            { categorie: "ergonomique", pct: 35, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "chute", pct: 25, priorite: "ELEVE", emoji: "ü™ú" },
            { categorie: "mecanique", pct: 15, priorite: "MOYEN", emoji: "üîß" },
            { categorie: "violence", pct: 12, priorite: "ELEVE", emoji: "‚ö†Ô∏è" },
            { categorie: "psychosocial", pct: 8, priorite: "MOYEN", emoji: "üß†" },
            { categorie: "thermique", pct: 5, priorite: "MOYEN", emoji: "üî•" }
        ],
        certifications: ["SIMDUT", "Manutention", "Cariste", "Premiers soins"],
        epi: ["chaussures s√©curit√©", "gants manutention", "ceinture lombaire"],
        mots_cles: ["manutention", "bo√Æte", "palette", "escabeau", "vol", "agression"]
    },
    "72": {
        scian: "72",
        nom: "H√©bergement et restauration",
        nom_court: "Resto/H√¥tel",
        emoji: "üçΩÔ∏è",
        lesions_annuelles: 15000,
        risques_prioritaires: [
            { categorie: "ergonomique", pct: 28, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "chute", pct: 22, priorite: "ELEVE", emoji: "ü™ú" },
            { categorie: "thermique", pct: 20, priorite: "ELEVE", emoji: "üî•" },
            { categorie: "coupure", pct: 15, priorite: "ELEVE", emoji: "üî™" },
            { categorie: "chimique", pct: 8, priorite: "MOYEN", emoji: "üß™" },
            { categorie: "psychosocial", pct: 7, priorite: "MOYEN", emoji: "üß†" }
        ],
        certifications: ["SIMDUT", "Hygi√®ne alimentaire", "Premiers soins", "MAPAQ"],
        epi: ["chaussures antid√©rapantes", "tablier", "gants cuisine", "gants four"],
        mots_cles: ["br√ªlure", "coupure", "huile chaude", "plancher glissant", "stress"]
    },
    "48": {
        scian: "48",
        nom: "Transport",
        nom_court: "Transport",
        emoji: "üöõ",
        lesions_annuelles: 12000,
        risques_prioritaires: [
            { categorie: "ergonomique", pct: 30, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "mecanique", pct: 25, priorite: "CRITIQUE", emoji: "üîß" },
            { categorie: "chute", pct: 18, priorite: "ELEVE", emoji: "ü™ú" },
            { categorie: "collision", pct: 12, priorite: "CRITIQUE", emoji: "üöõ" },
            { categorie: "psychosocial", pct: 10, priorite: "MOYEN", emoji: "üß†" },
            { categorie: "vibration", pct: 5, priorite: "MOYEN", emoji: "„Ä∞Ô∏è" }
        ],
        certifications: ["Classe 1/3", "Cariste", "SIMDUT", "Mati√®res dangereuses"],
        epi: ["chaussures s√©curit√©", "gilet haute visibilit√©", "gants"],
        mots_cles: ["camion", "chargement", "quai", "chariot √©l√©vateur", "fatigue"]
    },
    "21": {
        scian: "21",
        nom: "Extraction mini√®re",
        nom_court: "Mines",
        emoji: "‚õèÔ∏è",
        lesions_annuelles: 3000,
        risques_prioritaires: [
            { categorie: "mecanique", pct: 28, priorite: "CRITIQUE", emoji: "üîß" },
            { categorie: "chute", pct: 18, priorite: "CRITIQUE", emoji: "ü™ú" },
            { categorie: "effondrement", pct: 15, priorite: "CRITIQUE", emoji: "‚õèÔ∏è" },
            { categorie: "chimique", pct: 12, priorite: "ELEVE", emoji: "üß™" },
            { categorie: "bruit", pct: 12, priorite: "ELEVE", emoji: "üîä" },
            { categorie: "ergonomique", pct: 10, priorite: "ELEVE", emoji: "ü¶¥" }
        ],
        certifications: ["Module minier", "Espace clos", "SIMDUT", "Sauvetage minier"],
        epi: ["casque lampe", "bottes cap acier", "lunettes", "auto-sauveteur"],
        mots_cles: ["souterrain", "dynamitage", "ventilation", "machinerie lourde"]
    },
    "22": {
        scian: "22",
        nom: "Services publics",
        nom_court: "√ânergie/Eau",
        emoji: "‚ö°",
        lesions_annuelles: 2500,
        risques_prioritaires: [
            { categorie: "electrique", pct: 30, priorite: "CRITIQUE", emoji: "‚ö°" },
            { categorie: "chute", pct: 20, priorite: "CRITIQUE", emoji: "ü™ú" },
            { categorie: "mecanique", pct: 18, priorite: "ELEVE", emoji: "üîß" },
            { categorie: "espace_clos", pct: 12, priorite: "CRITIQUE", emoji: "üï≥Ô∏è" },
            { categorie: "chimique", pct: 10, priorite: "ELEVE", emoji: "üß™" },
            { categorie: "ergonomique", pct: 10, priorite: "MOYEN", emoji: "ü¶¥" }
        ],
        certifications: ["√âlectricit√© haute tension", "LOTO", "Espace clos", "Travail en hauteur"],
        epi: ["gants isolants", "harnais", "casque", "lunettes arc flash", "d√©tecteur gaz"],
        mots_cles: ["haute tension", "poteau", "transformateur", "√©gout", "chlore"]
    },
    "54": {
        scian: "54",
        nom: "Services professionnels",
        nom_court: "Services pro",
        emoji: "üíº",
        lesions_annuelles: 3000,
        risques_prioritaires: [
            { categorie: "ergonomique", pct: 45, priorite: "CRITIQUE", emoji: "ü¶¥" },
            { categorie: "psychosocial", pct: 30, priorite: "ELEVE", emoji: "üß†" },
            { categorie: "chute", pct: 10, priorite: "MOYEN", emoji: "ü™ú" },
            { categorie: "electrique", pct: 8, priorite: "MOYEN", emoji: "‚ö°" },
            { categorie: "violence", pct: 7, priorite: "MOYEN", emoji: "‚ö†Ô∏è" }
        ],
        certifications: ["Premiers soins", "Ergonomie bureau"],
        epi: ["chaise ergonomique", "√©cran ajustable", "clavier ergonomique"],
        mots_cles: ["√©cran", "posture", "stress", "surcharge", "t√©l√©travail"]
    }
};

// ============================================================================
// VARIABLES GLOBALES
// ============================================================================

let selectedSector = null;
let generatedCypher = '';
let generatedSections = {};

// ============================================================================
// INITIALISATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    renderSectors();
});

function renderSectors() {
    const grid = document.getElementById('sectorsGrid');
    
    // Trier par l√©sions annuelles
    const sorted = Object.values(PROFILS_CNESST).sort((a, b) => b.lesions_annuelles - a.lesions_annuelles);
    
    grid.innerHTML = sorted.map(profil => `
        <div class="sector-card glass-card p-4 text-center" 
             data-scian="${profil.scian}"
             onclick="selectSector('${profil.scian}')">
            <div class="text-3xl mb-2">${profil.emoji}</div>
            <div class="font-semibold text-sm">${profil.nom_court}</div>
            <div class="text-xs text-gray-400">SCIAN ${profil.scian}</div>
            <div class="text-xs text-orange-400 mt-1">${profil.lesions_annuelles.toLocaleString()}/an</div>
        </div>
    `).join('');
}

// ============================================================================
// S√âLECTION DU SECTEUR
// ============================================================================

function selectSector(scian) {
    selectedSector = PROFILS_CNESST[scian];
    
    // Mettre √† jour l'UI des cartes
    document.querySelectorAll('.sector-card').forEach(card => {
        card.classList.remove('selected');
        if (card.dataset.scian === scian) {
            card.classList.add('selected');
        }
    });
    
    // Afficher le profil de risques
    renderRiskProfile();
    
    // Afficher les sections suivantes
    document.getElementById('riskProfileSection').style.display = 'block';
    document.getElementById('optionsSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    
    // Scroll vers le profil
    document.getElementById('riskProfileSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderRiskProfile() {
    const profil = selectedSector;
    
    document.getElementById('selectedSectorName').textContent = `‚Äî ${profil.nom} (SCIAN ${profil.scian})`;
    document.getElementById('lesionsCount').textContent = profil.lesions_annuelles.toLocaleString();
    document.getElementById('risksCount').textContent = profil.risques_prioritaires.length;
    
    // Certifications
    document.getElementById('certificationsList').innerHTML = profil.certifications.map(c => 
        `<span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded text-xs">${c}</span>`
    ).join('');
    
    // EPI
    document.getElementById('epiList').innerHTML = profil.epi.map(e => 
        `<span class="bg-green-500/20 text-green-400 px-2 py-1 rounded text-xs">${e}</span>`
    ).join('');
    
    // Risques
    document.getElementById('risksList').innerHTML = profil.risques_prioritaires.map(r => {
        const priorityClass = r.priorite === 'CRITIQUE' ? 'priority-critical' : 
                             r.priorite === 'ELEVE' ? 'priority-high' : 'priority-medium';
        return `
            <div class="bg-white/5 rounded-lg p-3 ${priorityClass}">
                <div class="flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <span>${r.emoji}</span>
                        <span class="font-medium capitalize">${r.categorie}</span>
                    </span>
                    <span class="text-orange-400 font-bold">${r.pct}%</span>
                </div>
                <div class="text-xs text-gray-400 mt-1">Priorit√©: ${r.priorite}</div>
            </div>
        `;
    }).join('');
}

// ============================================================================
// G√âN√âRATION DES REQU√äTES CYPHER
// ============================================================================

function generateCypher() {
    const btn = document.getElementById('generateBtn');
    btn.innerHTML = '<span class="generating">‚ö° G√©n√©ration en cours...</span>';
    btn.disabled = true;
    
    setTimeout(() => {
        const profil = selectedSector;
        const orgName = document.getElementById('orgName').value;
        const nbEmployes = document.getElementById('nbEmployes').value;
        
        // Options s√©lectionn√©es
        const options = {
            diagnostic: document.getElementById('optDiagnostic').checked,
            risques: document.getElementById('optRisques').checked,
            alertes: document.getElementById('optAlertes').checked,
            conformite: document.getElementById('optConformite').checked,
            agents: document.getElementById('optAgents').checked,
            dashboard: document.getElementById('optDashboard').checked
        };
        
        // G√©n√©rer les sections
        generatedSections = {};
        let fullCypher = generateHeader(profil);
        
        if (options.diagnostic) {
            generatedSections['diagnostic'] = generateDiagnostic(profil);
            fullCypher += generatedSections['diagnostic'];
        }
        
        if (options.risques) {
            generatedSections['risques'] = generateRisques(profil);
            fullCypher += generatedSections['risques'];
        }
        
        if (options.alertes) {
            generatedSections['alertes'] = generateAlertes(profil);
            fullCypher += generatedSections['alertes'];
        }
        
        if (options.conformite) {
            generatedSections['conformite'] = generateConformite(profil);
            fullCypher += generatedSections['conformite'];
        }
        
        if (options.agents) {
            generatedSections['agents'] = generateAgents(profil);
            fullCypher += generatedSections['agents'];
        }
        
        if (options.dashboard) {
            generatedSections['dashboard'] = generateDashboard(profil);
            fullCypher += generatedSections['dashboard'];
        }
        
        fullCypher += generateFooter(profil);
        
        generatedCypher = fullCypher;
        
        // Afficher les r√©sultats
        renderResults(options);
        
        btn.innerHTML = '<span>‚ö°</span><span>G√©n√©rer les requ√™tes</span>';
        btn.disabled = false;
        
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 500);
}

function getScianFilter(profil) {
    const scian = profil.scian;
    let codes = [scian];
    
    if (scian === '236') codes = ['236', '237', '238'];
    if (scian === '621') codes = ['621', '622', '623', '624'];
    if (scian === '31') codes = ['31', '311', '312'];
    if (scian === '32') codes = ['32', '321', '322', '323', '324', '325'];
    if (scian === '33') codes = ['33', '331', '332', '333'];
    if (scian === '44') codes = ['44', '441', '442', '443', '444', '445'];
    if (scian === '48') codes = ['48', '481', '482', '483', '484'];
    
    return `o.sector_scian IN ['${codes.join("', '")}']`;
}

function generateHeader(profil) {
    const date = new Date().toLocaleString('fr-CA');
    return `// ============================================================================
// üõ°Ô∏è REQU√äTES CYPHER G√âN√âR√âES - SafetyGraph
// ============================================================================
// Secteur: ${profil.nom} (SCIAN ${profil.scian})
// Profil de risques: CNESST Qu√©bec
// L√©sions annuelles secteur: ${profil.lesions_annuelles.toLocaleString()}
// G√©n√©r√© le: ${date}
// G√©n√©rateur: SafetyGraph Web Interface
// ============================================================================

`;
}

function generateDiagnostic(profil) {
    const filter = getScianFilter(profil);
    return `
// ============================================================================
// üìã DIAGNOSTIC INITIAL
// ============================================================================

// Vue d'ensemble de l'organisation
MATCH (o:Organization)
WHERE ${filter}
OPTIONAL MATCH (o)<-[:APPARTIENT_A]-(z:Zone)
OPTIONAL MATCH (z)<-[:LOCALISE_DANS]-(r:RisqueDanger)
OPTIONAL MATCH (o)<-[:APPARTIENT_A]-(t:Team)<-[:MEMBRE_DE]-(p:Person)
RETURN o.name AS organisation,
       o.nb_employes AS employes,
       count(DISTINCT z) AS nb_zones,
       count(DISTINCT r) AS nb_risques,
       count(DISTINCT p) AS nb_travailleurs,
       round(avg(r.probabilite * r.gravite) * 100) / 100 AS score_risque_moyen
ORDER BY nb_risques DESC;

// Distribution des zones par niveau de risque
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)
WHERE ${filter}
RETURN z.risk_level AS niveau_risque,
       count(z) AS nb_zones
ORDER BY CASE z.risk_level 
    WHEN 'critique' THEN 1 
    WHEN 'eleve' THEN 2 
    WHEN 'moyen' THEN 3 
    ELSE 4 END;

// R√©partition des risques par cat√©gorie
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
RETURN r.categorie AS categorie,
       count(r) AS nb_risques,
       round(avg(r.probabilite * r.gravite) * 100) / 100 AS score_moyen
ORDER BY nb_risques DESC;

`;
}

function generateRisques(profil) {
    const filter = getScianFilter(profil);
    const topRisques = profil.risques_prioritaires.slice(0, 3);
    
    let cypher = `
// ============================================================================
// ‚ö†Ô∏è ANALYSE DES RISQUES PRIORITAIRES
// ============================================================================

`;
    
    topRisques.forEach((risque, i) => {
        cypher += `
// ${risque.emoji} Risques ${risque.categorie.toUpperCase()} (${risque.pct}% des l√©sions)
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
  AND r.categorie = '${risque.categorie}'
RETURN z.name AS zone,
       r.description AS risque,
       r.probabilite AS P,
       r.gravite AS G,
       r.probabilite * r.gravite AS score,
       CASE WHEN r.probabilite * r.gravite >= 15 THEN 'üî¥ TOL√âRANCE Z√âRO'
            WHEN r.probabilite * r.gravite >= 10 THEN 'üü† √âLEV√â'
            ELSE 'üü° MOD√âR√â' END AS priorite
ORDER BY score DESC
LIMIT 20;

// Travailleurs expos√©s aux risques ${risque.categorie}
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
MATCH (p:Person)-[:TRAVAILLE_DANS]->(z)
WHERE ${filter}
  AND r.categorie = '${risque.categorie}'
WITH p, count(DISTINCT r) AS nb_risques, max(r.probabilite * r.gravite) AS score_max
RETURN p.matricule AS travailleur,
       p.age_groupe AS age,
       nb_risques,
       score_max
ORDER BY score_max DESC
LIMIT 20;

`;
    });
    
    return cypher;
}

function generateAlertes(profil) {
    const filter = getScianFilter(profil);
    return `
// ============================================================================
// üö® ALERTES ET SURVEILLANCE PROACTIVE
// ============================================================================

// üî¥ Risques Tol√©rance Z√©ro (score >= 15)
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
  AND r.probabilite * r.gravite >= 15
RETURN 'üî¥ TOL√âRANCE Z√âRO' AS alerte,
       o.name AS organisation,
       z.name AS zone,
       r.categorie AS type_risque,
       r.description AS description,
       r.probabilite * r.gravite AS score
ORDER BY score DESC;

// üü† Concentration de risques (hotspots)
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
WITH z, o, count(r) AS nb_risques, avg(r.probabilite * r.gravite) AS score_moyen
WHERE nb_risques >= 3
RETURN z.name AS zone_hotspot,
       o.name AS organisation,
       nb_risques,
       round(score_moyen * 100) / 100 AS score_moyen
ORDER BY score_moyen DESC;

// üë§ Jeunes travailleurs (18-24) en zones √† risque
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
MATCH (p:Person)-[:TRAVAILLE_DANS]->(z)
WHERE ${filter}
  AND p.age_groupe = '18-24'
  AND r.probabilite * r.gravite >= 10
RETURN '‚ö†Ô∏è JEUNE TRAVAILLEUR' AS alerte,
       p.matricule AS travailleur,
       z.name AS zone,
       collect(DISTINCT r.categorie) AS types_risques;

// üë¥ Travailleurs 55+ expos√©s aux risques ergonomiques
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
MATCH (p:Person)-[:TRAVAILLE_DANS]->(z)
WHERE ${filter}
  AND p.age_groupe IN ['55-64', '65+']
  AND r.categorie = 'ergonomique'
RETURN '‚ö†Ô∏è SENIOR - RISQUE ERGO' AS alerte,
       p.matricule AS travailleur,
       z.name AS zone,
       r.description AS risque;

`;
}

function generateConformite(profil) {
    const filter = getScianFilter(profil);
    return `
// ============================================================================
// ‚úÖ CONFORMIT√â ET AUDIT
// ============================================================================

// V√©rification EPI par zone critique
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)
WHERE ${filter}
  AND z.risk_level IN ['critique', 'eleve']
RETURN z.name AS zone,
       z.risk_level AS niveau,
       z.epi_requis AS epi_definis,
       CASE WHEN z.epi_requis IS NULL OR size(z.epi_requis) = 0 
            THEN '‚ùå EPI NON D√âFINIS'
            ELSE '‚úÖ OK' END AS statut_epi;

// Taux de certification par √©quipe
MATCH (o:Organization)<-[:APPARTIENT_A]-(t:Team)<-[:MEMBRE_DE]-(p:Person)
WHERE ${filter}
WITH t, o,
     count(p) AS total,
     sum(CASE WHEN p.certifications_sst IS NOT NULL THEN 1 ELSE 0 END) AS certifies
RETURN o.name AS organisation,
       t.name AS equipe,
       total AS nb_membres,
       certifies AS nb_certifies,
       round(certifies * 100.0 / total) AS taux_certification
ORDER BY taux_certification ASC;

// Zones sans risques document√©s
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)
WHERE ${filter}
  AND NOT EXISTS { MATCH (z)<-[:LOCALISE_DANS]-(:RisqueDanger) }
RETURN o.name AS organisation,
       z.name AS zone_sans_risques,
       '‚ö†Ô∏è AUDIT REQUIS' AS action;

`;
}

function generateAgents(profil) {
    const filter = getScianFilter(profil);
    const topRisques = profil.risques_prioritaires.slice(0, 3).map(r => r.categorie);
    
    return `
// ============================================================================
// ü§ñ REQU√äTES POUR AGENTS IA
// ============================================================================

// Agent VisionAI - Zones prioritaires surveillance
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
  AND z.risk_level = 'critique'
RETURN DISTINCT z.name AS zone_surveillance,
       collect(DISTINCT r.categorie) AS types_risques,
       'VisionAI' AS agent;

// Agent ErgoAI - Postes √† analyser
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
MATCH (p:Person)-[:TRAVAILLE_DANS]->(z)
WHERE ${filter}
  AND r.categorie = 'ergonomique'
WITH z, count(DISTINCT p) AS nb_exposes
WHERE nb_exposes >= 3
RETURN z.name AS poste_analyse,
       nb_exposes AS travailleurs_exposes,
       'ErgoAI' AS agent;

// Agent AlertAI - D√©clencheurs
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
WITH z, o, avg(r.probabilite * r.gravite) AS score_moyen
WHERE score_moyen >= 10
RETURN o.name AS organisation,
       z.name AS zone,
       round(score_moyen * 100) / 100 AS score,
       CASE WHEN score_moyen >= 15 THEN 'CRITIQUE' ELSE '√âLEV√â' END AS niveau_alerte,
       'AlertAI' AS agent;

// Agent PredictAI - Features ML
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
WITH o,
     count(DISTINCT z) AS nb_zones,
     count(r) AS nb_risques,
     avg(r.probabilite * r.gravite) AS score_moyen,
     sum(CASE WHEN r.probabilite * r.gravite >= 15 THEN 1 ELSE 0 END) AS risques_TZ
RETURN o.name AS organisation,
       nb_zones, nb_risques,
       round(score_moyen * 100) / 100 AS score_moyen,
       risques_TZ AS tolerance_zero,
       round(nb_risques * 1.0 / nb_zones * 100) / 100 AS densite;

`;
}

function generateDashboard(profil) {
    const filter = getScianFilter(profil);
    return `
// ============================================================================
// üìä DONN√âES POUR DASHBOARD
// ============================================================================

// Risques par cat√©gorie (graphique barres)
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
RETURN r.categorie AS label,
       count(r) AS value
ORDER BY value DESC;

// Zones par niveau (graphique donut)
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)
WHERE ${filter}
RETURN z.risk_level AS label, count(z) AS value;

// Matrice de risques (scatter plot)
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
RETURN r.probabilite AS x,
       r.gravite AS y,
       count(r) AS size,
       r.categorie AS category;

// KPIs globaux
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
WITH count(DISTINCT o) AS orgs,
     count(DISTINCT z) AS zones,
     count(r) AS risques,
     sum(CASE WHEN r.probabilite * r.gravite >= 15 THEN 1 ELSE 0 END) AS TZ,
     avg(r.probabilite * r.gravite) AS score_moy
RETURN orgs, zones, risques, TZ,
       round(score_moy * 100) / 100 AS score_moyen;

// Top 10 organisations par niveau de risque
MATCH (o:Organization)<-[:APPARTIENT_A]-(z:Zone)<-[:LOCALISE_DANS]-(r:RisqueDanger)
WHERE ${filter}
WITH o, count(r) AS nb_risques, avg(r.probabilite * r.gravite) AS score
RETURN o.name AS organisation, nb_risques, round(score * 100) / 100 AS score_moyen
ORDER BY score DESC
LIMIT 10;

`;
}

function generateFooter(profil) {
    return `
// ============================================================================
// FIN DES REQU√äTES - SCIAN ${profil.scian} - ${profil.nom_court.toUpperCase()}
// ============================================================================
`;
}

// ============================================================================
// AFFICHAGE DES R√âSULTATS
// ============================================================================

function renderResults(options) {
    // Compter les requ√™tes
    const queryCount = (generatedCypher.match(/^MATCH|^RETURN|^WITH/gm) || []).length;
    document.getElementById('queryCount').textContent = `(~${Math.round(queryCount/2)} requ√™tes)`;
    
    // Tabs
    const tabs = [];
    if (options.diagnostic) tabs.push({ id: 'diagnostic', label: 'üìã Diagnostic', icon: 'üìã' });
    if (options.risques) tabs.push({ id: 'risques', label: '‚ö†Ô∏è Risques', icon: '‚ö†Ô∏è' });
    if (options.alertes) tabs.push({ id: 'alertes', label: 'üö® Alertes', icon: 'üö®' });
    if (options.conformite) tabs.push({ id: 'conformite', label: '‚úÖ Conformit√©', icon: '‚úÖ' });
    if (options.agents) tabs.push({ id: 'agents', label: 'ü§ñ Agents IA', icon: 'ü§ñ' });
    if (options.dashboard) tabs.push({ id: 'dashboard', label: 'üìä Dashboard', icon: 'üìä' });
    tabs.unshift({ id: 'all', label: 'üìÑ Tout', icon: 'üìÑ' });
    
    document.getElementById('categoryTabs').innerHTML = tabs.map((tab, i) => `
        <button class="tab-btn ${i === 0 ? 'active' : ''} bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg text-sm border border-white/10"
                onclick="showSection('${tab.id}')">
            ${tab.label}
        </button>
    `).join('');
    
    // Code
    showSection('all');
}

function showSection(sectionId) {
    // Update tabs
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Show code
    let code;
    if (sectionId === 'all') {
        code = generatedCypher;
    } else {
        code = generatedSections[sectionId] || '';
    }
    
    document.getElementById('cypherCode').textContent = code;
    Prism.highlightElement(document.getElementById('cypherCode'));
}

// ============================================================================
// ACTIONS
// ============================================================================

function copyAllCypher() {
    navigator.clipboard.writeText(generatedCypher).then(() => {
        const btn = document.getElementById('copyAllBtn');
        btn.innerHTML = '<span>‚úÖ</span> Copi√© !';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.innerHTML = '<span>üìã</span> Copier tout';
            btn.classList.remove('copied');
        }, 2000);
    });
}

function downloadCypher() {
    const profil = selectedSector;
    const filename = `cypher_${profil.nom_court.toLowerCase().replace(/[^a-z0-9]/g, '_')}_scian${profil.scian}.cypher`;
    
    const blob = new Blob([generatedCypher], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
